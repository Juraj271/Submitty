var file_array=[],previous_files=[],label_array=[],use_previous=!1,changed=!1,empty_inputs=!0,student_ids=[],student_without_ids=[];function initializeDragAndDrop(){file_array=[],previous_files=[],label_array=[],use_previous=!1,changed=!1,empty_inputs=!0,student_ids=[],student_without_ids=[]}function createArray(e){if(0==file_array.length)for(var a=0;a<e;a++)file_array.push([]),previous_files.push([]),label_array.push([])}function readPrevious(e,a){changed=!1,previous_files[a-1].push(e)}function setUsePrevious(){use_previous=!0}function clicked_on_box(e){document.getElementById("input-file"+get_part_number(e)).click(),e.stopPropagation()}function draghandle(e){e.preventDefault(),e.stopPropagation(),document.getElementById("upload"+get_part_number(e)).style.opacity="dragenter"==e.type||"dragover"==e.type?.5:""}function drop(e){draghandle(e);for(var a=e.dataTransfer.files,r=get_part_number(e),t=0;t<a.length;t++)addFileWithCheck(a[t],r)}function dropWithMultipleZips(e){draghandle(e);for(var a=e.dataTransfer.files,r=get_part_number(e),t=0;t<a.length;t++)addFileWithCheck(a[t],r,!1)}function progress(e){var a=document.getElementById("loading-bar");if(!a)return!1;if(e.lengthComputable){a.max=e.total,a.value=e.loaded;let r=100*e.loaded/e.total;$("#loading-bar-percentage").html(r.toFixed(2)+" %")}}function get_part_number(e){return"upload"==e.target.id.substring(0,6)?e.target.id.substring(6):e.target.parentNode.id.substring(6)}function addFilesFromInput(e,a=!0){for(var r=document.getElementById("input-file"+e).files,t=0;t<r.length;t++)addFile(r[t],e,a);$("#input-file"+e).val("")}function fileExists(e,a){for(var r=0;r<previous_files[a-1].length;r++)if(previous_files[a-1][r]==e)return[1,r];for(var t=0;t<file_array[a-1].length;t++)if(file_array[a-1][t].name==e)return[0,t];return[-1]}function addFileWithCheck(e,a,r=!0){if(e.type&&e.size%4096!=0)addFile(e,a,r);else{var t=new FileReader;t.onload=notFolder(e,a),t.onerror=isFolder(e),t.readAsBinaryString(e)}}function notFolder(e,a){return function(r){addFile(e,a)}}function isFolder(e){return function(a){alert("Upload failed: "+e.name+" might be a folder.")}}function addFile(e,a,r=!0){var t=fileExists(e.name,a);-1==t[0]?(r&&".zip"==e.name.substring(e.name.length-4,e.name.length)&&file_array[a-1].length+previous_files[a-1].length>0&&confirm("Note: All files currently in the bucket will be deleted if you try to upload a zip: "+e.name+". Do you want to continue?")&&deleteFiles(a),file_array[a-1].push(e),addLabel(e.name,(e.size/1024).toFixed(2),a,!1)):0==t[0]?confirm("Note: "+file_array[a-1][t[1]].name+" is already selected. Do you want to replace it?")&&(file_array[a-1].splice(t[1],1,e),removeLabel(e.name,a),addLabel(e.name,(e.size/1024).toFixed(2),a,!1)):confirm("Note: "+previous_files[a-1][t[1]]+" was in your previous submission. Do you want to replace it?")&&(file_array[a-1].push(e),previous_files[a-1].splice(t[1],1),removeLabel(e.name,a),addLabel(e.name,(e.size/1024).toFixed(2),a,!1),changed=!0),setButtonStatus()}function deleteFiles(e){0!=file_array.length&&(file_array[e-1]=[]),0!=previous_files.length&&(previous_files[e-1]=[]);for(var a=document.getElementById("upload"+e),r=a.getElementsByClassName("mylabel");r[0];)a.removeChild(r[0]);label_array[e-1]=[],changed=!0,setButtonStatus()}function deleteSingleFile(e,a,r){if(r){for(var t=0;t<previous_files[a-1].length;t++)if(previous_files[a-1][t]==e){previous_files[a-1].splice(t,1),label_array[a-1].splice(t,1),changed=!0;break}}else for(var i=0;i<file_array[a-1].length;i++)if(file_array[a-1][i].name==e){file_array[a-1].splice(i,1),label_array[a-1].splice(i,1);break}setButtonStatus()}function setButtonStatus(){for(var e=0,a=0;a<label_array.length;a++)e+=label_array[a].length;0==e?($("#startnew").prop("disabled",!0),empty_inputs?$("#submit").prop("disabled",!0):$("#submit").prop("disabled",!1)):($("#startnew").prop("disabled",!1),$("#submit").prop("disabled",!1));for(var r=0,t=0;t<file_array.length;t++)r+=file_array[t].length;use_previous&&!changed&&0==r?$("#getprev").prop("disabled",!0):use_previous&&$("#getprev").prop("disabled",!1)}function removeLabel(e,a){for(var r=document.getElementById("upload"+a),t=r.getElementsByClassName("mylabel"),i=0;i<t.length;i++)if(t[i].getAttribute("fname")==e){r.removeChild(t[i]),label_array[a-1].splice(i,1);break}}function addLabel(e,a,r,t){var i=document.createElement("label");i.setAttribute("class","mylabel"),i.setAttribute("fname",e),i.innerHTML=e+" "+a+"kb <i role='text' aria-label='Press enter to remove file "+e+"' tabindex='0' class='fas fa-trash custom-focus'></i><br />",i.children[0].onmouseover=function(e){e.stopPropagation(),this.style.color="#FF3933"},i.children[0].onmouseout=function(e){e.stopPropagation(),this.style.color="black"},i.children[0].onclick=function(a){a.stopPropagation(),this.parentNode.parentNode.removeChild(this.parentNode),deleteSingleFile(e,r,t)},i.children[0].onkeypress=function(a){a.stopPropagation(),this.parentNode.parentNode.removeChild(this.parentNode),deleteSingleFile(e,r,t)},document.getElementById("upload"+r).appendChild(i),label_array[r-1].push(e)}function handle_input_keypress(){empty_inputs=!1,setButtonStatus()}function openFile(e){window.open(e,"_blank","toolbar=no,scrollbars=yes,resizable=yes, width=700, height=600")}function moveNextInput(e){var a="#users_"+(e+1)+" :first";if($(a).length){$(a).focus(),$(a).select();var r,t=$(a).offset().top,i=$(a).height(),n=$(window).height();r=i<n?t-(n/2-i/2):t,$("html, body").animate({scrollTop:r},500)}}function isValidSubmission(){for(var e=0;e<file_array.length;e++)if(0!=file_array[e].length)return!0;if(changed)for(var a=0;a<previous_files.length;a++)if(0!=previous_files[a])return!0;return!!window.hasOwnProperty("is_notebook")}function validateUserId(e,a,r){var t=buildCourseUrl(["gradeable",a,"verify"]);return new Promise(function(a,i){$.ajax({url:t,data:{csrf_token:e,user_id:r},type:"POST",success:function(e){"success"===(e=JSON.parse(e)).status?a(e):i(e)},error:function(e){console.log("Error while trying to validate user id"+r),i({status:"failed",message:e})}})})}function displaySubmissionMessage(e){let a=new Date,r=String(a.getTime()),t='class="inner-message alert '+("success"===e.status?"alert-success":"alert-error")+'"',i='<a class="fas fa-times message-close" onclick="removeMessagePopup('+r+');"></a>',n='<i class="'+("success"===e.status?"fas fa-check-circle":"fas fa-times-circle")+'"></i>',o="success"===e.status?e.data:e.message,s='<div id="'+r+'"'+t+">"+n+o+i+"</div>";$("#messages").append(s),"success"===e.status&&setTimeout(function(){removeMessagePopup(r)},5e3)}function displayPreviousSubmissionOptions(e){var a,r,t=$("#previous-submission-form"),i=t.find(".submit-button"),n=t.find(".close-button");i.attr("tabindex","0"),n.attr("tabindex","0"),i.on("click",function(){$("#instructor-submit-option-new").is(":checked")?(localStorage.setItem("instructor-submit-option","0"),a=1):$("#instructor-submit-option-merge-1").is(":checked")?(localStorage.setItem("instructor-submit-option","1"),a=2):$("#instructor-submit-option-merge-2").is(":checked")&&(localStorage.setItem("instructor-submit-option","2"),a=3),t.css("display","none"),e(a)}),n.on("click",function(){$("#instructor-submit-option-new").is(":checked")?localStorage.setItem("instructor-submit-option","0"):$("#instructor-submit-option-merge-1").is(":checked")?localStorage.setItem("instructor-submit-option","1"):$("#instructor-submit-option-merge-2").is(":checked")&&localStorage.setItem("instructor-submit-option","2"),t.css("display","none"),e(-1)}),$(".popup-form").css("display","none"),t.css("display","block"),r=null===localStorage.getItem("instructor-submit-option")?0:parseInt(localStorage.getItem("instructor-submit-option")),t.find("input:radio")[r].checked=!0,$("#instructor-submit-option-new").attr("tabindex","0"),$("#instructor-submit-option-merge-1").attr("tabindex","0"),$("#instructor-submit-option-merge-2").attr("tabindex","0"),i.focus();var o=4;"none"!==t.css("display")&&document.addEventListener("keydown",e=>{9==e.keyCode?($("input[name=instructor-submit]").css({outline:"none"}),e.preventDefault(),0===o?($("#instructor-submit-option-merge-1").focus(),$("#instructor-submit-option-merge-1").css({outline:"2px solid #C1E0FF"})):1===o?($("#instructor-submit-option-merge-2").focus(),$("#instructor-submit-option-merge-2").css({outline:"2px solid #C1E0FF"})):2===o?n.focus():3===o?i.focus():4===o&&($("#instructor-submit-option-new").focus(),$("#instructor-submit-option-new").css({outline:"2px solid #C1E0FF"})),o=4==o?0:o+1):27===e.keyCode?n.click():13===e.keyCode&&(1===o?($("input[name=instructor-submit]").prop("checked",!1),$("#instructor-submit-option-merge-1").prop("checked",!0)):2===o?($("input[name=instructor-submit]").prop("checked",!1),$("#instructor-submit-option-merge-2").prop("checked",!0)):0===o?($("input[name=instructor-submit]").prop("checked",!1),$("#instructor-submit-option-new").prop("checked",!0)):3===o?n.click():4===o&&i.click())})}function submitSplitItem(e,a,r,t,i=!1,n=!1){var o=buildCourseUrl(["gradeable",a,"split_pdf","upload"])+"?merge="+i+"&clobber="+n;return new Promise(function(a,i){$.ajax({url:o,data:{csrf_token:e,user_id:r,path:t},type:"POST",success:function(e){"success"===(e=JSON.parse(e)).status?a(e):i(e)},error:function(e){console.log("Failed while submiting split item"),i({status:"failed",message:e})}})})}function deleteSplitItem(e,a,r){var t=buildCourseUrl(["gradeable",a,"split_pdf","delete"]);return new Promise(function(a,i){$.ajax({url:t,data:{csrf_token:e,path:r},type:"POST",success:function(e){"success"===(e=JSON.parse(e)).status?a(e):i(e)},error:function(e,a,r){console.error("Failed while deleting split item"),i({status:"failed",message:a})}})})}function handleBulk(e,a,r=!1,t="",i=""){$("#submit").prop("disabled",!0);var n=new FormData;if(!r){if(""==a)return alert("You didn't enter the # of page(s)!"),void $("#submit").prop("disabled",!1);if(a<1||a%1!=0)return alert(a+" is not a valid # of page(s)!"),void $("#submit").prop("disabled",!1)}n.append("num_pages",a),n.append("use_qr_codes",r),n.append("qr_prefix",encodeURIComponent(t)),n.append("qr_suffix",encodeURIComponent(i)),n.append("csrf_token",csrfToken);for(var o=0;o<file_array.length;o++)for(var s=0;s<file_array[o].length;s++){if(-1!=file_array[o][s].name.indexOf("'")||-1!=file_array[o][s].name.indexOf('"'))return void alert("ERROR! You may not use quotes in your filename: "+file_array[o][s].name);if(-1!=file_array[o][s].name.indexOf("\\")||-1!=file_array[o][s].name.indexOf("/"))return void alert("ERROR! You may not use a slash in your filename: "+file_array[o][s].name);if(-1!=file_array[o][s].name.indexOf("<")||-1!=file_array[o][s].name.indexOf(">"))return void alert("ERROR! You may not use angle brackets in your filename: "+file_array[o][s].name);n.append("files"+(o+1)+"[]",file_array[o][s],file_array[o][s].name)}var l=buildCourseUrl(["gradeable",e,"bulk"]),u=buildCourseUrl(["gradeable",e]);$.ajax({url:l,data:n,processData:!1,contentType:!1,type:"POST",success:function(e){$("#submit").prop("disabled",!1);try{"success"===(e=JSON.parse(e)).status?window.location.href=u:"You do not have access to that page."==e.message?window.location.href=u:alert("ERROR! \n\n"+e.message)}catch(a){alert("Error parsing response from server. Please copy the contents of your Javascript Console and send it to an administrator, as well as what you were doing and what files you were uploading."),console.log(e)}},error:function(){$("#submit").prop("disabled",!1),alert("ERROR! Please contact administrator that you could not upload files.")}})}function gatherInputAnswersByType(e){var a={};if("codebox"==e)var r=$("div[id^="+e+"_]");else r=$("[id^="+e+"_]");"codebox"!=e&&(r=r.serializeArray());for(var t=0;t<r.length;t++){var i=r[t],n="",o="";"codebox"==e?(n=i.id,o=i.querySelector(".CodeMirror").CodeMirror.getValue()):(n=i.name,o=i.value),n in a||(a[n]=Array()),a[n].push(o)}return a}function handleSubmission(e,a,r,t,i,n,o,s,l,u,d,p,c,f,m=!1,y=!1){$("#submit").prop("disabled",!0);var g=buildCourseUrl(["gradeable",l,"upload"])+"?merge="+m+"&clobber="+y,_=buildCourseUrl(["gradeable",l]),b="";if(t>=i&&(b="You have already made "+t+" submissions.  You are allowed "+i+" submissions before a small point penalty will be applied. Are you sure you want to continue?",!confirm(b)))return;if(e>0&&e<=r){if(b="Your submission will be "+e+" day(s) late. Are you sure you want to use "+a+" late day(s)?",!confirm(b))return}else if(e>0&&(b="Your submission will be "+e+" days late. You are not supposed to submit unless you have an excused absence. Are you sure you want to continue?",!confirm(b)))return;var h=new FormData;h.append("csrf_token",n),h.append("vcs_checkout",o),h.append("user_id",u),h.append("git_user_id",d),h.append("git_repo_id",p),h.append("student_page",c);let v=0;if(!o){if(!isValidSubmission()&&empty_inputs)return alert("Not a new submission."),void window.location.reload();for(var w=0;w<file_array.length;w++)for(var x=0;x<file_array[w].length;x++){if(-1!=file_array[w][x].name.indexOf("'")||-1!=file_array[w][x].name.indexOf('"'))return void alert("ERROR! You may not use quotes in your filename: "+file_array[w][x].name);if(-1!=file_array[w][x].name.indexOf("\\")||-1!=file_array[w][x].name.indexOf("/"))return void alert("ERROR! You may not use a slash in your filename: "+file_array[w][x].name);if(-1!=file_array[w][x].name.indexOf("<")||-1!=file_array[w][x].name.indexOf(">"))return void alert("ERROR! You may not use angle brackets in your filename: "+file_array[w][x].name);v+=file_array[w][x].size,h.append("files"+(w+1)+"[]",file_array[w][x],file_array[w][x].name)}h.append("previous_files",JSON.stringify(previous_files))}v>1e7&&$(".loading-bar-wrapper").fadeIn(100);var O=gatherInputAnswersByType("short_answer"),k=gatherInputAnswersByType("multiple_choice"),R=gatherInputAnswersByType("codebox");if(h.append("short_answer_answers",JSON.stringify(O)),h.append("multiple_choice_answers",JSON.stringify(k)),h.append("codebox_answers",JSON.stringify(R)),c){var S=[];for(w=0;w<f;w++){if(S[w]=$("#page_"+w).val(),""==S[w])return alert("You cannot leave a page input empty."),void $("#submit").prop("disabled",!1);if(parseInt(S[w])<1)return alert("Page numbers cannot be less than 1."),void $("#submit").prop("disabled",!1)}h.append("pages",JSON.stringify(S))}$.ajax({url:g,data:h,processData:!1,xhr:function(){var e=$.ajaxSettings.xhr();return e.upload&&e.upload.addEventListener("progress",progress,!1),e},contentType:!1,type:"POST",success:function(e){$("#submit").prop("disabled",!1);try{"success"===(e=JSON.parse(e)).status?window.location.href=_:"You do not have access to that page."==e.message?window.location.href=_:alert("ERROR! Please contact administrator with following error:\n\n"+e.message)}catch(a){alert("Error parsing response from server. Please copy the contents of your Javascript Console and send it to an administrator, as well as what you were doing and what files you were uploading."),console.log(e)}},error:function(e){$("#submit").prop("disabled",!1),alert("ERROR! Please contact administrator that you could not upload files.")}})}function handleDownloadImages(e){var a=buildCourseUrl(["student_photos","upload"]),r=buildCourseUrl(["student_photos"]),t=new FormData;t.append("csrf_token",e),t.append("file_count",file_array.length);for(var i=0;i<file_array.length;i++)for(var n=0;n<file_array[i].length;n++){if(-1!=file_array[i][n].name.indexOf("'")||-1!=file_array[i][n].name.indexOf('"'))return void alert("ERROR! You may not use quotes in your filename: "+file_array[i][n].name);if(-1!=file_array[i][n].name.indexOf("\\")||-1!=file_array[i][n].name.indexOf("/"))return void alert("ERROR! You may not use a slash in your filename: "+file_array[i][n].name);if(-1!=file_array[i][n].name.indexOf("<")||-1!=file_array[i][n].name.indexOf(">"))return void alert("ERROR! You may not use angle brackets in your filename: "+file_array[i][n].name);t.append("files"+(i+1)+"[]",file_array[i][n],file_array[i][n].name)}$.ajax({url:a,data:t,processData:!1,contentType:!1,type:"POST",success:function(e){try{"success"===(e=JSON.parse(e)).status?window.location.href=r:alert("ERROR! Please contact administrator with following error:\n\n"+e.message)}catch(a){alert("Error parsing response from server. Please copy the contents of your Javascript Console and send it to an administrator, as well as what you were doing and what files you were uploading."),console.log(e)}},error:function(e){window.location.href=buildCourseUrl(["student_photos"])}})}function handleUploadCourseMaterials(e,a,r,t,i){var n=buildCourseUrl(["course_materials","upload"]),o=buildCourseUrl(["course_materials"]),s=new FormData;s.append("csrf_token",e),s.append("expand_zip",a),s.append("requested_path",t),s.append("release_time",i);var l=r;t&&t.trim().length&&(l=r+t),"/"==l[l.length-1]&&(l=l.slice(0,-1));for(var u=!1,d=0;d<file_array.length;d++)for(var p=0;p<file_array[d].length;p++){if(-1!=file_array[d][p].name.indexOf("'")||-1!=file_array[d][p].name.indexOf('"'))return void alert("ERROR! You may not use quotes in your filename: "+file_array[d][p].name);if(-1!=file_array[d][p].name.indexOf("\\")||-1!=file_array[d][p].name.indexOf("/"))return void alert("ERROR! You may not use a slash in your filename: "+file_array[d][p].name);if(-1!=file_array[d][p].name.indexOf("<")||-1!=file_array[d][p].name.indexOf(">"))return void alert("ERROR! You may not use angle brackets in your filename: "+file_array[d][p].name);if(1==fileExists(l+"/"+file_array[d][p].name,1)[0]){var c=!1;if("on"==a&&"zip"==getFileExtension(file_array[d][p].name).toLowerCase()&&(c=!0),!c&&!confirm("Note: "+file_array[d][p].name+" already exists. Do you want to replace it?"))continue}s.append("files"+(d+1)+"[]",file_array[d][p],file_array[d][p].name),u=!0}0!=u&&$.ajax({url:n,data:s,processData:!1,contentType:!1,type:"POST",success:function(e){try{var a=JSON.parse(e);"success"===a.status?window.location.href=o:alert(a.message)}catch(a){alert("Error parsing response from server. Please copy the contents of your Javascript Console and send it to an administrator, as well as what you were doing and what files you were uploading. - [handleUploadCourseMaterials]"),console.log(e)}},error:function(e){window.location.href=buildCourseUrl(["course_materials"])}})}