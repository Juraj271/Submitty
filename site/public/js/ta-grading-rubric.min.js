function displayAjaxError(e){console.error("Failed to parse response.  The server isn't playing nice..."),console.error(e)}function ajaxGetGradeableRubric(e){return new Promise(function(n,t){$.getJSON({type:"GET",async:AJAX_USE_ASYNC,url:buildCourseUrl(["gradeable",e,"rubric"]),success:function(e){"success"!==e.status?(console.error("Something went wrong fetching the gradeable rubric: "+e.message),t(new Error(e.message))):n(e.data)},error:function(e){displayAjaxError(e),t(e)}})})}function ajaxSaveComponent(e,n,t,o,r,a,i,s,c,u){return new Promise(function(l,d){$.getJSON({type:"POST",async:AJAX_USE_ASYNC,url:buildCourseUrl(["gradeable",e,"components","save"]),data:{csrf_token:csrfToken,component_id:n,title:t,ta_comment:o,student_comment:r,page_number:a,lower_clamp:i,default:s,max_value:c,upper_clamp:u,peer:!1},success:function(e){"success"!==e.status?(console.error("Something went wrong saving the component: "+e.message),d(new Error(e.message))):l(e.data)},error:function(e){displayAjaxError(e),d(e)}})})}function ajaxGetComponentRubric(e,n){return new Promise(function(t,o){$.getJSON({type:"GET",async:AJAX_USE_ASYNC,url:buildCourseUrl(["gradeable",e,"components"])+`?component_id=${n}`,success:function(e){"success"!==e.status?(console.error("Something went wrong fetching the component rubric: "+e.message),o(new Error(e.message))):t(e.data)},error:function(e){displayAjaxError(e),o(e)}})})}function ajaxGetGradedGradeable(e,n){return new Promise(function(t,o){$.getJSON({type:"GET",async:AJAX_USE_ASYNC,url:buildCourseUrl(["gradeable",e,"grading","graded_gradeable"])+`?anon_id=${n}`,success:function(e){"success"!==e.status?(console.error("Something went wrong fetching the gradeable grade: "+e.message),o(new Error(e.message))):t(e.data)},error:function(e){displayAjaxError(e),o(e)}})})}function ajaxGetGradedComponent(e,n,t){return new Promise(function(o,r){$.getJSON({type:"GET",async:AJAX_USE_ASYNC,url:buildCourseUrl(["gradeable",e,"grading","graded_gradeable","graded_component"])+`?anon_id=${t}&component_id=${n}`,success:function(e){"success"!==e.status?(console.error("Something went wrong fetching the component grade: "+e.message),r(new Error(e.message))):(null===e.data&&(e.data=void 0),o(e.data))},error:function(e){displayAjaxError(e),r(e)}})})}function ajaxSaveGradedComponent(e,n,t,o,r,a,i,s){return new Promise(function(c,u){$.getJSON({type:"POST",async:AJAX_USE_ASYNC,url:buildCourseUrl(["gradeable",e,"grading","graded_gradeable","graded_component"]),data:{csrf_token:csrfToken,component_id:n,anon_id:t,graded_version:o,custom_points:r,custom_message:a,silent_edit:i,mark_ids:s},success:function(e){"success"!==e.status?(console.error("Something went wrong saving the component grade: "+e.message),u(new Error(e.message))):c(e.data)},error:function(e){displayAjaxError(e),u(e)}})})}function ajaxGetOverallComment(e,n){return new Promise(function(t,o){$.getJSON({type:"GET",async:AJAX_USE_ASYNC,url:buildCourseUrl(["gradeable",e,"grading","comments"])+`?anon_id=${n}`,data:null,success:function(e){"success"!==e.status?(console.error("Something went wrong fetching the gradeable comment: "+e.message),o(new Error(e.message))):t(e.data)},error:function(e){displayAjaxError(e),o(e)}})})}function ajaxSaveOverallComment(e,n,t){return new Promise(function(o,r){$.getJSON({type:"POST",async:AJAX_USE_ASYNC,url:buildCourseUrl(["gradeable",e,"grading","comments"]),data:{csrf_token:csrfToken,gradeable_id:e,anon_id:n,overall_comment:t},success:function(e){"success"!==e.status?(console.error("Something went wrong saving the overall comment: "+e.message),r(new Error(e.message))):o(e.data)},error:function(e){displayAjaxError(e),r(e)}})})}function ajaxAddNewMark(e,n,t,o,r){return new Promise(function(a,i){$.getJSON({type:"POST",async:AJAX_USE_ASYNC,url:buildCourseUrl(["gradeable",e,"components","marks","add"]),data:{csrf_token:csrfToken,component_id:n,title:t,points:o,publish:r},success:function(e){"success"!==e.status?(console.error("Something went wrong adding a new mark: "+e.message),i(new Error(e.message))):a(e.data)},error:function(e){displayAjaxError(e),i(e)}})})}function ajaxDeleteMark(e,n,t){return new Promise(function(o,r){$.getJSON({type:"POST",async:AJAX_USE_ASYNC,url:buildCourseUrl(["gradeable",e,"components","marks","delete"]),data:{csrf_token:csrfToken,component_id:n,mark_id:t},success:function(e){"success"!==e.status?(console.error("Something went wrong deleting the mark: "+e.message),r(new Error(e.message))):o(e.data)},error:function(e){displayAjaxError(e),r(e)}})})}function ajaxSaveMark(e,n,t,o,r,a){return new Promise(function(i,s){$.getJSON({type:"POST",async:AJAX_USE_ASYNC,url:buildCourseUrl(["gradeable",e,"components","marks","save"]),data:{csrf_token:csrfToken,component_id:n,mark_id:t,points:r,title:o,publish:a},success:function(e){"success"!==e.status?(console.error("Something went wrong saving the mark: "+e.message),s(new Error(e.message))):i(e.data)},error:function(e){displayAjaxError(e),s(e)}})})}function ajaxGetMarkStats(e,n,t){return new Promise(function(o,r){$.getJSON({type:"POST",async:AJAX_USE_ASYNC,url:buildCourseUrl(["gradeable",e,"components","marks","stats"]),data:{component_id:n,mark_id:t,csrf_token:csrfToken},success:function(e){"success"!==e.status?(console.error("Something went wrong getting mark stats: "+e.message),r(new Error(e.message))):o(e.data)},error:function(e){displayAjaxError(e),r(e)}})})}function ajaxSaveMarkOrder(e,n,t){return new Promise(function(o,r){$.getJSON({type:"POST",async:AJAX_USE_ASYNC,url:buildCourseUrl(["gradeable",e,"components","marks","save_order"]),data:{csrf_token:csrfToken,component_id:n,order:JSON.stringify(t)},success:function(e){"success"!==e.status?(console.error("Something went wrong saving the mark order: "+e.message),r(new Error(e.message))):o(e.data)},error:function(e){displayAjaxError(e),r(e)}})})}function ajaxSaveComponentPages(e,n){return new Promise(function(t,o){$.getJSON({type:"POST",async:AJAX_USE_ASYNC,url:buildCourseUrl(["gradeable",e,"components","save_pages"]),data:{csrf_token:csrfToken,pages:JSON.stringify(n)},success:function(e){"success"!==e.status?(console.error("Something went wrong saving the component pages: "+e.message),o(new Error(e.message))):t(e.data)},error:function(e){displayAjaxError(e),o(e)}})})}function ajaxSaveComponentOrder(e,n){return new Promise(function(t,o){$.getJSON({type:"POST",async:AJAX_USE_ASYNC,url:buildCourseUrl(["gradeable",e,"components","order"]),data:{csrf_token:csrfToken,order:JSON.stringify(n)},success:function(e){"success"!==e.status?(console.error("Something went wrong saving the component order: "+e.message),o(new Error(e.message))):t(e.data)},error:function(e){displayAjaxError(e),o(e)}})})}function ajaxAddComponent(e){return new Promise(function(n,t){$.getJSON({type:"POST",async:AJAX_USE_ASYNC,url:buildCourseUrl(["gradeable",e,"components","new"]),data:{csrf_token:csrfToken},success:function(e){"success"!==e.status?(console.error("Something went wrong adding the component: "+e.message),t(new Error(e.message))):n(e.data)},error:function(e){displayAjaxError(e),t(e)}})})}function ajaxDeleteComponent(e,n){return new Promise(function(t,o){$.getJSON({type:"POST",async:AJAX_USE_ASYNC,url:buildCourseUrl(["gradeable",e,"components","delete"]),data:{csrf_token:csrfToken,component_id:n},success:function(e){"success"!==e.status?(console.error("Something went wrong deleting the component: "+e.message),o(new Error(e.message))):t(e.data)},error:function(e){displayAjaxError(e),o(e)}})})}function ajaxVerifyComponent(e,n,t){return new Promise(function(o,r){$.getJSON({type:"POST",async:!0,url:buildCourseUrl(["gradeable",e,"components","verify"]),data:{csrf_token:csrfToken,component_id:n,anon_id:t},success:function(e){"success"!==e.status?(console.error("Something went wrong verifying the component: "+e.message),r(new Error(e.message))):o(e.data)},error:function(e){displayAjaxError(e),r(e)}})})}function ajaxVerifyAllComponents(e,n){return new Promise(function(t,o){$.getJSON({type:"POST",async:!0,url:buildCourseUrl(["gradeable",e,"components","verify"])+"?verify_all=true",data:{csrf_token:csrfToken,component_id:component_id,anon_id:n},success:function(e){"success"!==e.status?(console.error("Something went wrong verifying the all components: "+e.message),o(new Error(e.message))):t(e.data)},error:function(e){displayAjaxError(e),o(e)}})})}function showVerifyComponent(e,n){return void 0!==e&&""!==e.grader_id&&n!==e.grader_id}function getGradeableId(){return $("#gradeable-rubric").attr("data-gradeable_id")}function getAnonId(){return $("#anon-id").attr("data-anon_id")}function getGraderId(){return $("#grader-info").attr("data-grader_id")}function isInstructorEditEnabled(){return $("#edit-gradeable-instructor-flag").length>0}function canVerifyGraders(){return $("#grader-info").attr("data-can_verify")}function isGradingDisabled(){return $("#version-conflict-indicator").length>0}function getDisplayVersion(){return parseInt($("#gradeable-version-container").attr("data-gradeable_version"))}function getPointPrecision(){return parseFloat($("#point_precision_id").val())}function isEditModeEnabled(){return EDIT_MODE_ENABLED||isInstructorEditEnabled()}function updateEditModeEnabled(){EDIT_MODE_ENABLED=$("#edit-mode-enabled").is(":checked")}function isSilentEditModeEnabled(){return $("#silent-edit-id").is(":checked")}function getNewMarkId(){return MARK_ID_COUNTER--}function setRubricDOMElements(e){$("#grading-box").html(e),isInstructorEditEnabled()&&setupSortableComponents()}function getComponentIdFromDOMElement(e){return $(e).hasClass("component")?parseInt($(e).attr("data-component_id")):parseInt($(e).parents(".component").attr("data-component_id"))}function getMarkIdFromDOMElement(e){return $(e).hasClass("mark-container")?parseInt($(e).attr("data-mark_id")):parseInt($(e).parents(".mark-container").attr("data-mark_id"))}function getComponentJQuery(e){return $("#component-"+e)}function getMarkJQuery(e){return $("#mark-"+e)}function getCustomMarkJQuery(e){return getComponentJQuery(e).find(".custom-mark-container")}function getOverallCommentJQuery(){return $("#overall-comment-container")}function setComponentInProgress(e,n=!0){let t=getComponentJQuery(e);t.find(".save-tools span").hide(),n?t.find(".save-tools-in-progress").show():t.find(".save-tools :not(.save-tools-in-progress)").show()}function setOverallCommentInProgress(e=!0){let n=getOverallCommentJQuery();n.find(".save-tools span").hide(),e?n.find(".save-tools-in-progress").show():n.find(".save-tools :not(.save-tools-in-progress)").show()}function setupSortableMarks(e){let n=getComponentJQuery(e).find(".ta-rubric-table");n.sortable({items:"div:not(.mark-first,.add-new-mark-container)"}),n.keydown(keyPressHandler),n.disableSelection()}function setupSortableComponents(){let e=$("#component-list");e.sortable({update:onComponentOrderChange,handle:".reorder-component-container"}),e.keydown(keyPressHandler),e.disableSelection()}function keyPressHandler(e){65===e.keyCode&&e.ctrlKey&&e.target.select()}function setOverallCommentContents(e){getOverallCommentJQuery().html(e)}function setComponentContents(e,n){getComponentJQuery(e).parent(".component-container").html(n),isEditModeEnabled()&&setupSortableMarks(e)}function setComponentHeaderContents(e,n){getComponentJQuery(e).find(".header-block").html(n)}function setTotalScoreBoxContents(e){$("#total-score-container").html(e)}function setRubricTotalBoxContents(e){$("#rubric-total-container").html(e)}function getCountDirection(e){return getComponentJQuery(e).find("input.count-up-selector").is(":checked")?COUNT_DIRECTION_UP:COUNT_DIRECTION_DOWN}function setMarkTitle(e,n){getMarkJQuery(e).find(".mark-title textarea").val(n)}function getAllComponentsFromDOM(){let e=[];return $(".component").each(function(){e.push(getComponentFromDOM(getComponentIdFromDOMElement(this)))}),e}function getComponentPageNumber(e){let n=getComponentJQuery(e);return isInstructorEditEnabled()?parseInt(n.find("input.page-number").val()):parseInt(n.attr("data-page"))}function getComponentFromDOM(e){let n=getComponentJQuery(e);if(isInstructorEditEnabled()&&isComponentOpen(e)){let t=Math.abs(parseFloat(n.find("input.penalty-points").val())),o=Math.abs(parseFloat(n.find("input.max-points").val())),r=Math.abs(parseFloat(n.find("input.extra-credit-points").val())),a=getCountDirection(e)!==COUNT_DIRECTION_DOWN;return{id:e,title:n.find("input.component-title").val(),ta_comment:n.find("textarea.ta-comment").val(),student_comment:n.find("textarea.student-comment").val(),page:getComponentPageNumber(e),lower_clamp:-t,default:a?0:o,max_value:o,upper_clamp:o+r,marks:getMarkListFromDOM(e)}}return{id:e,title:n.attr("data-title"),ta_comment:n.attr("data-ta_comment"),student_comment:n.attr("data-student_comment"),page:parseInt(n.attr("data-page")),lower_clamp:parseFloat(n.attr("data-lower_clamp")),default:parseFloat(n.attr("data-default")),max_value:parseFloat(n.attr("data-max_value")),upper_clamp:parseFloat(n.attr("data-upper_clamp")),marks:getMarkListFromDOM(e)}}function getMarkListFromDOM(e){let n=[],t=0;return getComponentJQuery(e).find(".ta-rubric-table .mark-container").each(function(){let e=getMarkFromDOM(parseInt($(this).attr("data-mark_id")));null!==e&&(e.order=t,n.push(e),t++)}),n}function getMarkFromDOM(e){let n=getMarkJQuery(e);return isEditModeEnabled()?{id:parseInt(n.attr("data-mark_id")),points:parseFloat(n.find("input[type=number]").val()),title:n.find("textarea").val(),deleted:n.hasClass("mark-deleted"),publish:n.find(".mark-publish-container input[type=checkbox]").is(":checked")}:0===e?null:{id:parseInt(n.attr("data-mark_id")),points:parseFloat(n.find(".mark-points").attr("data-points")),title:n.find(".mark-title").attr("data-title"),publish:"true"===n.attr("data-publish")}}function componentExists(e){return getComponentJQuery(e).length>0}function getGradedComponentFromDOM(e){let n=getComponentJQuery(e),t=n.find(".custom-mark-container"),o=[],r=!1;n.find("span.mark-selected").each(function(){let e=parseInt($(this).attr("data-mark_id"));e===CUSTOM_MARK_ID?r=!0:o.push(e)});let a=0,i="";if(isEditModeEnabled()){let e=n.find(".custom-mark-data");a=parseFloat(e.attr("data-score")),i=e.attr("data-comment"),r="true"===e.attr("data-selected")}else a=parseFloat(t.find("input[type=number]").val()),i=t.find("textarea").val();let s=n.find(".graded-component-data"),c=s.attr("data-graded_version");return""===c&&(c=getDisplayVersion()),{score:a,comment:i,custom_mark_selected:r,mark_ids:o,graded_version:parseInt(c),grade_time:s.attr("data-grade_time"),grader_id:s.attr("data-grader_id"),verifier_id:s.attr("data-verifier_id")}}function getScoresFromDOM(){let e=$("#gradeable-scores-id"),n={ta_grading_complete:getTaGradingComplete(),ta_grading_earned:getTaGradingEarned(),ta_grading_total:getTaGradingTotal(),auto_grading_complete:!1},t=e.attr("data-auto_grading_total");return""!==t&&(n.auto_grading_earned=parseInt(e.attr("data-auto_grading_earned")),n.auto_grading_total=parseInt(t),n.auto_grading_complete=!0),n}function getRubricTotalFromDOM(){let e=0,n=0;return getAllComponentsFromDOM().forEach(function(t){e+=t.max_value,n+=t.upper_clamp-t.max_value}),{total:e,extra_credit:n}}function getTaGradingEarned(){let e=0,n=!1;if($(".graded-component-data").each(function(){let t=$(this).attr("data-total_score");""!==t&&(e+=parseFloat(t),n=!0)}),n)return e}function getTaGradingComplete(){let e=!1;return $(".graded-component-data").each(function(){""===$(this).attr("data-total_score")&&(e=!0)}),!e}function getTaGradingTotal(){let e=0;return $(".component").each(function(){e+=parseFloat($(this).attr("data-max_value"))}),e}function getOverallCommentFromDOM(){let e=$("span#overall-comment"),n=$("textarea#overall-comment");return n.length>0?n.val():n.length>0?e.html():""}function getOpenComponentIds(){let e=[];return $(".ta-rubric-table:visible").each(function(){e.push(parseInt($(this).attr("data-component_id")))}),e}function getComponentIdByOrder(e){return $(".component-container").eq(e).find(".component").attr("data-component_id")}function getComponentOrders(){let e={};return $(".component").each(function(n){let t=getComponentIdFromDOMElement(this);e[t]=n}),e}function getNextComponentId(e){return getComponentJQuery(e).parent(".component-container").next().children(".component").attr("data-component_id")}function getPrevComponentId(e){return getComponentJQuery(e).parent(".component-container").prev().children(".component").attr("data-component_id")}function getFirstOpenComponentId(){let e=getOpenComponentIds();return 0===e.length?NO_COMPONENT_ID:e[0]}function getComponentCount(){return $(".component-container").length}function getMarkIdFromOrder(e,n){let t=getComponentJQuery(e).find(".mark-container");return n<t.length?parseInt(t.eq(n).attr("data-mark_id")):0}function getOpenComponentIdFromCookie(){let e=document.cookie.replace(/(?:(?:^|.*;\s*)open_component_id\s*\=\s*([^;]*).*$)|^.*$/,"$1");return e=parseInt(e),isNaN(e)?NO_COMPONENT_ID:e}function updateCookieComponent(){document.cookie="open_component_id="+getFirstOpenComponentId()+"; path=/;"}function getComponentFirstMarkId(e){return parseInt(getComponentJQuery(e).find(".mark-container").first().attr("data-mark_id"))}function isComponentOpen(e){return!getComponentJQuery(e).find(".ta-rubric-table").is(":hidden")}function isOverallCommentOpen(){return $("textarea#overall-comment").length>0}function isMarkChecked(e){return getMarkJQuery(e).find("span.mark-selected").length>0}function isMarkDisabled(e){return getMarkJQuery(e).hasClass("mark-disabled")}function isMarkDeleted(e){return getMarkJQuery(e).hasClass("mark-deleted")}function hasCustomMark(e){return!isEditModeEnabled()&&""!==getGradedComponentFromDOM(e).comment}function isCustomMarkChecked(e){return getCustomMarkJQuery(e).find(".mark-selected").length>0}function checkDOMCustomMark(e){getCustomMarkJQuery(e).find(".mark-selector").addClass("mark-selected")}function unCheckDOMCustomMark(e){getCustomMarkJQuery(e).find(".mark-selector").removeClass("mark-selected")}function toggleDOMCustomMark(e){getCustomMarkJQuery(e).find(".mark-selector").toggleClass("mark-selected")}function openMarkStatsPopup(e,n,t){let o=$("#student-marklist-popup");o.find(".question-title").html(e),o.find(".mark-title").html(n),o.find(".section-submitter-count").html(t.section_submitter_count),o.find(".total-submitter-count").html(t.total_submitter_count),o.find(".section-graded-component-count").html(t.section_graded_component_count),o.find(".total-graded-component-count").html(t.total_graded_component_count),o.find(".section-total-component-count").html(t.section_total_component_count),o.find(".total-total-component-count").html(t.total_total_component_count);let r=[],[a,i]=location.href.split("?");i=new URLSearchParams(i),t.submitter_ids.forEach(function(e){i.set("who_id",e),r.push(`<a href="${a}?${i.toString()}">${e}</a>`)}),o.find(".student-names").html(r.join(", ")),$(".popup-form").hide(),o.show()}function anyUnverifiedComponents(){return $(".verify-container").length>0}function updateVerifyAllButton(){anyUnverifiedComponents()?$("#verify-all").show():$("#verify-all").hide()}function getComponentVersionConflict(e){return void 0!==e&&e.graded_version!==getDisplayVersion()}function setCustomMarkError(e,n){let t=getComponentJQuery(e).find("textarea.mark-note-custom"),o="custom-mark-error";n?(t.addClass(o),t.prop("title","Custom mark cannot be blank!")):(t.removeClass(o),t.prop("title",""))}function disableEditModeBox(e){$("#edit-mode-enabled").prop("disabled",e)}function onAddNewMark(e){addNewMark(getComponentIdFromDOMElement(e)).catch(function(e){console.error(e),alert("Error adding mark! "+e.message)})}function onDeleteMark(e){$(e).parents(".mark-container").toggleClass("mark-deleted")}function onRestoreMark(e){$(e).parents(".mark-container").toggleClass("mark-deleted")}function onDeleteComponent(e){confirm("Are you sure you want to delete this component?")&&deleteComponent(getComponentIdFromDOMElement(e)).catch(function(e){console.error(e),alert("Failed to delete component! "+e.message)}).then(function(){return reloadInstructorEditRubric(getGradeableId())}).catch(function(e){alert("Failed to reload rubric! "+e.message)})}function onAddComponent(){addComponent().catch(function(e){console.error(e),alert("Failed to add component! "+e.message)}).then(function(){return closeAllComponents(!0)}).then(function(){return reloadInstructorEditRubric(getGradeableId())}).then(function(){return openComponent(getComponentIdByOrder(getComponentCount()-1))}).catch(function(e){alert("Failed to reload rubric! "+e.message)})}function importComponentsFromFile(){let e=buildCourseUrl(["gradeable",getGradeableId(),"components","import"]),n=new FormData,t=$("#import-components-file")[0].files;if(0!==t.length){for(let e=0;e<t.length;e++)n.append("files"+e,t[e],t[e].name);n.append("csrf_token",csrfToken),$.getJSON({url:e,data:n,processData:!1,contentType:!1,type:"POST",success:function(e){"success"!==e.status?(console.error("Something went wrong importing components: "+e.message),reject(new Error(e.message))):location.reload()},error:function(e){alert("Error parsing response from server. Please copy the contents of your Javascript Console and send it to an administrator, as well as what you were doing and what files you were uploading. - [handleUploadGradeableComponents]")}})}}function onMarkPointsChange(e){refreshComponentHeader(getComponentIdFromDOMElement(e),!0).catch(function(e){console.error(e),alert("Error updating component! "+e.message)})}function onGetMarkStats(e){let n=getComponentIdFromDOMElement(e),t=getMarkIdFromDOMElement(e);ajaxGetMarkStats(getGradeableId(),n,t).then(function(e){openMarkStatsPopup(getComponentFromDOM(n).title,getMarkFromDOM(t).title,e)}).catch(function(e){alert("Failed to get stats for mark: "+e.message)})}function onClickComponent(e){let n=getComponentIdFromDOMElement(e);toggleComponent(n,!0).catch(function(e){console.error(e),setComponentInProgress(n,!1),alert("Error opening/closing component! "+e.message)})}function onCancelComponent(e){toggleComponent(getComponentIdFromDOMElement(e),!1).catch(function(e){console.error(e),alert("Error closing component! "+e.message)})}function onClickOverallComment(e){toggleOverallComment(!0).catch(function(e){console.error(e),alert("Error opening/closing overall comment! "+e.message)})}function onComponentOrderChange(){ajaxSaveComponentOrder(getGradeableId(),getComponentOrders()).catch(function(e){console.error(e),alert("Error reordering components! "+e.message)})}function onCancelOverallComment(e){toggleOverallComment(!1).catch(function(e){console.error(e),alert("Error closing overall comment! "+e.message)})}function onToggleMark(e){toggleCommonMark(getComponentIdFromDOMElement(e),getMarkIdFromDOMElement(e)).catch(function(e){console.error(e),alert("Error toggling mark! "+e.message)})}function onCustomMarkChange(e){updateCustomMark(getComponentIdFromDOMElement(e)).catch(function(e){console.error(e),alert("Error updating custom mark! "+e.message)})}function onToggleCustomMark(e){let n=getComponentIdFromDOMElement(e);""!==getGradedComponentFromDOM(n).comment?(toggleDOMCustomMark(n),toggleCustomMark(n).catch(function(e){console.error(e),alert("Error toggling custom mark! "+e.message)})):setCustomMarkError(n,!0)}function onVerifyComponent(e){verifyComponent(getComponentIdFromDOMElement(e)).catch(function(e){console.error(e),alert("Error verifying component! "+e.message)})}function onVerifyAll(e){verifyAllComponents().catch(function(e){console.error(e),alert("Error verifying all components! "+e.message)})}function onToggleEditMode(e){let n=getOpenComponentIds(),t=NO_COMPONENT_ID;if(disableEditModeBox(!0),0===n.length)return updateEditModeEnabled(),void disableEditModeBox(!1);setComponentInProgress(t=n[0]);let o=Promise.resolve();(o=o.then(function(){return saveComponent(t)})).catch(function(e){console.error(e),alert("Error saving component! "+e.message)}).then(function(){if(updateEditModeEnabled(),t!==NO_COMPONENT_ID)return reloadGradingComponent(t,isEditModeEnabled(),!0)}).catch(function(e){console.error(e),alert("Error reloading component! "+e.message)}).then(function(){disableEditModeBox(!1)})}function onClickCountUp(e){setMarkTitle(getComponentFirstMarkId(getComponentIdFromDOMElement(e)),"No Credit"),$.get("Mark.twig",null,function(){$("input[id^='mark-editor-']").each(function(){$(this).attr("overall","No Credit"),this.value<0?this.style.backgroundColor="var(--standard-vibrant-yellow)":this.style.backgroundColor="var(--default-white)"})})}function onClickCountDown(e){setMarkTitle(getComponentFirstMarkId(getComponentIdFromDOMElement(e)),"Full Credit"),$.get("Mark.twig",null,function(){$("input[id^='mark-editor-']").each(function(){$(this).attr("overall","Full Credit"),this.value>0?this.style.backgroundColor="var(--standard-vibrant-yellow)":this.style.backgroundColor="var(--default-white)"})})}function onComponentPointsChange(e){dividesEvenly($(e).val(),getPointPrecision())?($(e).css("background-color","#ffffff"),refreshInstructorEditComponentHeader(getComponentIdFromDOMElement(e),!0).catch(function(e){console.error(e),alert("Failed to refresh component! "+e.message)})):$(e).css("background-color","#ff7777")}function dividesEvenly(e,n){var t=Math.pow(10,Math.max(decimalLength(e),decimalLength(n)));return e*t%(n*t)==0}function decimalLength(e){return(e.toString().split(".")[1]||"").length}function onComponentTitleChange(e){getComponentJQuery(getComponentIdFromDOMElement(e)).find(".component-title-text").text($(e).val())}function onComponentPageNumberChange(e){getComponentJQuery(getComponentIdFromDOMElement(e)).find(".component-page-number-text").text($(e).val())}function onMarkPublishChange(e){getMarkJQuery(getMarkIdFromDOMElement(e)).toggleClass("mark-publish")}function verifyComponent(e){return ajaxVerifyComponent(getGradeableId(),e,getAnonId()).then(function(){return reloadGradingComponent(e)}).then(function(){updateVerifyAllButton()})}function verifyAllComponents(){let e=getGradeableId(),n=getAnonId();return ajaxVerifyAllComponents(e,n).then(function(){return reloadGradingRubric(e,n)}).then(function(){updateVerifyAllButton()})}function addComponent(){return ajaxAddComponent(getGradeableId())}function deleteComponent(e){return ajaxDeleteComponent(getGradeableId(),e)}function setPdfPageAssignment(e){return e===PDF_PAGE_INSTRUCTOR&&(e=1),closeAllComponents(!0).then(function(){return ajaxSaveComponentPages(getGradeableId(),{page:e})}).then(function(){return reloadInstructorEditRubric(getGradeableId())})}function getMarkFromMarkArray(e,n){for(let t=0;t<e.length;++t)if(e[t].id===n)return e[t];return null}function reloadGradingRubric(e,n){let t=null;return ajaxGetGradeableRubric(e).catch(function(e){alert("Could not fetch gradeable rubric: "+e.message)}).then(function(o){return t=o,ajaxGetGradedGradeable(e,n)}).catch(function(e){alert("Could not fetch graded gradeable: "+e.message)}).then(function(e){return renderGradingGradeable(getGraderId(),t,e,isGradingDisabled(),canVerifyGraders(),getDisplayVersion())}).then(function(e){return setRubricDOMElements(e),openCookieComponent()}).catch(function(e){alert("Could not render gradeable: "+e.message),console.error(e)})}function reloadInstructorEditRubric(e){return ajaxGetGradeableRubric(e).catch(function(e){alert("Could not fetch gradeable rubric: "+e.message)}).then(function(e){return renderInstructorEditGradeable(e)}).then(function(e){return setRubricDOMElements(e),refreshRubricTotalBox()}).then(function(){return openCookieComponent()}).catch(function(e){alert("Could not render gradeable: "+e.message),console.error(e)})}function reloadGradingComponent(e,n=!1,t=!1){let o=null,r=getGradeableId();return ajaxGetComponentRubric(r,e).then(function(n){return OLD_MARK_LIST[e]=n.marks,o=n,ajaxGetGradedComponent(r,e,getAnonId())}).then(function(r){return OLD_GRADED_COMPONENT_LIST[e]=r,injectGradingComponent(o,r,n,t)})}function openCookieComponent(){let e=getOpenComponentIdFromCookie();return componentExists(e)?toggleComponent(e,!1).then(function(){scrollToComponent(e)}):Promise.resolve()}function closeAllComponents(e){let n=Promise.resolve();return isOverallCommentOpen()&&(n=n.then(function(){return closeOverallComment(!0)})),getOpenComponentIds().forEach(function(e){n=n.then(function(){return closeComponent(e)})}),n}function toggleComponent(e,n){let t=Promise.resolve();return(t=isComponentOpen(e)?t.then(function(){return closeComponent(e,n)}):t.then(function(){return closeAllComponents(n).then(function(){return openComponent(e)})})).then(function(){updateCookieComponent()})}function toggleOverallComment(e){if(isOverallCommentOpen())return closeOverallComment(e);let n=Promise.resolve();return getOpenComponentIds().forEach(function(e){n=n.then(function(){return closeComponent(e)})}),n.then(openOverallComment)}function addNewMark(e){let n=getComponentFromDOM(e);n.marks.push({id:getNewMarkId(),title:"",points:0,publish:!1,order:n.marks.length});let t=Promise.resolve();if(isInstructorEditEnabled())t=t.then(function(){return injectInstructorEditComponent(n,!0)});else{let o=getGradedComponentFromDOM(e);t=t.then(function(){return injectGradingComponent(n,o,!0,!0)})}return t}function toggleCommonMark(e,n){return isMarkChecked(n)?unCheckMark(e,n):checkMark(e,n)}function updateCustomMark(e){return hasCustomMark(e)?(checkDOMCustomMark(e),unCheckFirstMark(e)):(unCheckDOMCustomMark(e),refreshGradedComponent(e,!0))}function toggleCustomMark(e){return isCustomMarkChecked(e)?unCheckFirstMark(e):refreshGradedComponent(e,!0)}function openComponentInstructorEdit(e){return ajaxGetComponentRubric(getGradeableId(),e).then(function(n){return OLD_MARK_LIST[e]=n.marks,injectInstructorEditComponent(n,!0)})}function openComponentGrading(e){return reloadGradingComponent(e,isEditModeEnabled(),!0).then(function(){let n=getComponentPageNumber(e);n&&scrollToPage(n)})}function scrollToPage(e){let n=$(".openable-element-submissions");for(let t=0;t<n.length;t++)if("upload.pdf"==n[t].innerText.trim()){let o=$("#pageContainer"+e);$("#file_view").is(":visible")?o.length&&$("#file_content").animate({scrollTop:o[0].offsetTop},500):expandFile("upload.pdf",n[t].getAttribute("file-url"),e-1)}}function openComponent(e){return setComponentInProgress(e),(isInstructorEditEnabled()?openComponentInstructorEdit(e):openComponentGrading(e)).then(resizeNoScrollTextareas)}function scrollToComponent(e){getComponentJQuery(e)[0].scrollIntoView()}function closeComponentInstructorEdit(e,n){let t=Promise.resolve();return n&&(t=t.then(function(){return saveMarkList(e)}).then(function(){let n=getComponentFromDOM(e);return ajaxSaveComponent(getGradeableId(),e,n.title,n.ta_comment,n.student_comment,n.page,n.lower_clamp,n.default,n.max_value,n.upper_clamp)})),t.then(function(){return ajaxGetComponentRubric(getGradeableId(),e)}).then(function(e){return injectInstructorEditComponent(e,!1)})}function closeComponentGrading(e,n){let t=Promise.resolve(),o=getGradeableId(),r=getAnonId(),a=null;return n&&(t=t.then(function(){return saveComponent(e)})),t.then(function(){return ajaxGetComponentRubric(o,e)}).then(function(e){a=e}).then(function(){return ajaxGetGradedComponent(o,e,r)}).then(function(e){return injectGradingComponent(a,e,!1,!1)})}function closeComponent(e,n=!0){return setComponentInProgress(e),(isInstructorEditEnabled()?closeComponentInstructorEdit(e,n):closeComponentGrading(e,n)).then(function(){setComponentInProgress(e,!1)})}function openOverallComment(){return setOverallCommentInProgress(),ajaxGetOverallComment(getGradeableId(),getAnonId()).then(function(e){return injectOverallComment(e,!0)})}function closeOverallComment(e=!0){return setOverallCommentInProgress(),e?ajaxSaveOverallComment(getGradeableId(),getAnonId(),getOverallCommentFromDOM()).then(function(){return refreshOverallComment(!1)}):ajaxGetOverallComment(getGradeableId(),getAnonId()).then(function(e){return injectOverallComment(e,!1)})}function scrollToOverallComment(){getOverallCommentJQuery()[0].scrollIntoView()}function checkMark(e,n){if(isMarkDisabled(n))return Promise.resolve();let t=getGradedComponentFromDOM(e);return isMarkChecked(getComponentFirstMarkId(e))&&t.mark_ids.splice(0,1),t.mark_ids.push(n),injectGradingComponent(getComponentFromDOM(e),t,!1,!0)}function unCheckMark(e,n){let t=getGradedComponentFromDOM(e);for(let e=0;e<t.mark_ids.length;++e)if(t.mark_ids[e]===n){t.mark_ids.splice(e,1);break}return injectGradingComponent(getComponentFromDOM(e),t,!1,!0)}function unCheckFirstMark(e){return unCheckMark(e,getComponentFirstMarkId(e))}function saveMarkList(e){let n=getGradeableId();return ajaxGetComponentRubric(n,e).then(function(t){let o=getMarkListFromDOM(e),r=t.marks,a=OLD_MARK_LIST[e],i={},s=Promise.resolve();return o.forEach(function(t){let o=getMarkFromMarkArray(r,t.id),c=getMarkFromMarkArray(a,t.id);s=s.then(function(){return tryResolveMarkSave(n,e,t,o,c)}).then(function(e){!1===e&&(i[t.id]={domMark:t,serverMark:o,oldServerMark:c,localDeleted:isMarkDeleted(t.id)})})}),s.then(function(){if(0!==Object.keys(i).length)return openMarkConflictPopup(e,i)}).then(function(){let t={};return o.forEach(function(e){t[e.id]=e.order}),ajaxSaveMarkOrder(n,e,t)})})}function marksEqual(e,n){return e.points===n.points&&e.title===n.title&&e.publish===n.publish}function tryResolveMarkSave(e,n,t,o,r){let a=isMarkDeleted(t.id);return null!==r?null!==o?!marksEqual(t,o)&&!marksEqual(t,r)||a?marksEqual(o,r)?a?ajaxDeleteMark(e,n,t.id).catch(function(e){throw e.message="Could not delete mark: "+e.message,e}).then(function(){return Promise.resolve(!0)}):ajaxSaveMark(e,n,t.id,t.title,t.points,t.publish).then(function(){return Promise.resolve(!0)}):Promise.resolve(!1):Promise.resolve(!0):marksEqual(t,r)||a?Promise.resolve(t.id):Promise.resolve(!1):a?Promise.resolve(!0):ajaxAddNewMark(e,n,t.title,t.points,t.publish).then(function(e){return t.id=e.mark_id,Promise.resolve(!0)}).catch(function(e){throw e.message="Failed to add mark: "+e.message,e})}function gradedComponentsEqual(e,n){if(void 0===n)return 0===e.mark_ids.length&&(!e.custom_mark_selected||0===e.score&&""===e.comment);if(e.graded_version!==n.graded_version)return!1;if(e.mark_ids.length!==n.mark_ids.length)return!1;for(let t=0;t<e.mark_ids.length;t++){let o=!1;for(let r=0;r<n.mark_ids.length;r++)n.mark_ids[r]===e.mark_ids[t]&&(o=!0);if(!o)return!1}return e.custom_mark_selected?e.score===n.score&&e.comment===n.comment:0===n.score&&""===n.comment}function saveComponent(e){if(isEditModeEnabled())return saveMarkList(e);{let n=getGradedComponentFromDOM(e);return""===n.comment||n.custom_mark_selected||confirm("Are you sure you want to delete the custom mark?")?saveGradedComponent(e):promise.reject()}}function saveGradedComponent(e){let n=getGradeableId(),t=getGradedComponentFromDOM(e);return t.graded_version=getDisplayVersion(),gradedComponentsEqual(t,OLD_GRADED_COMPONENT_LIST[e])?Promise.resolve():ajaxGetComponentRubric(getGradeableId(),e).then(function(o){let r=[],a=getComponentFromDOM(e);t.mark_ids.forEach(function(e){null===getMarkFromMarkArray(o.marks,e)&&r.push(getMarkFromMarkArray(a.marks,e))});let i=Promise.resolve();return r.forEach(function(o){i=i.then(function(){return ajaxAddNewMark(n,e,o.title,o.points,o.publish)}).then(function(e){t.mark_ids.push(e.mark_id)})}),i}).then(function(){return ajaxSaveGradedComponent(getGradeableId(),e,getAnonId(),t.graded_version,t.custom_mark_selected?t.score:0,t.custom_mark_selected?t.comment:"",isSilentEditModeEnabled(),t.mark_ids)})}function refreshGradedComponentHeader(e,n){return injectGradingComponentHeader(getComponentFromDOM(e),getGradedComponentFromDOM(e),n)}function refreshGradedComponent(e,n){return injectGradingComponent(getComponentFromDOM(e),getGradedComponentFromDOM(e),isEditModeEnabled(),n)}function refreshInstructorEditComponentHeader(e,n){return injectInstructorEditComponentHeader(getComponentFromDOM(e),n)}function refreshInstructorEditComponent(e,n){return injectInstructorEditComponent(getComponentFromDOM(e),n)}function refreshComponentHeader(e,n){return isInstructorEditEnabled()?refreshInstructorEditComponentHeader(e,n):refreshGradedComponentHeader(e,n)}function refreshComponent(e,n){return isInstructorEditEnabled()?refreshInstructorEditComponent(e,n):refreshGradedComponent(e,n)}function refreshOverallComment(e){return injectOverallComment(getOverallCommentFromDOM(),e)}function refreshTotalScoreBox(){return injectTotalScoreBox(getScoresFromDOM())}function refreshRubricTotalBox(){return injectRubricTotalBox(getRubricTotalFromDOM())}function injectInstructorEditComponent(e,n){return renderEditComponent(e,getPointPrecision(),n).then(function(n){setComponentContents(e.id,n)}).then(function(){return refreshRubricTotalBox()})}function injectInstructorEditComponentHeader(e,n){return renderEditComponentHeader(e,getPointPrecision(),n).then(function(n){setComponentHeaderContents(e.id,n)}).then(function(){return refreshRubricTotalBox()})}function injectGradingComponent(e,n,t,o){return renderGradingComponent(getGraderId(),e,n,isGradingDisabled(),canVerifyGraders(),getPointPrecision(),t,o,getComponentVersionConflict(n)).then(function(n){setComponentContents(e.id,n)}).then(function(){return refreshTotalScoreBox()})}function injectGradingComponentHeader(e,n,t){return renderGradingComponentHeader(getGraderId(),e,n,isGradingDisabled(),canVerifyGraders(),t,getComponentVersionConflict(n)).then(function(n){setComponentHeaderContents(e.id,n)}).then(function(){return refreshTotalScoreBox()})}function injectOverallComment(e,n){return renderOverallComment(e,n).then(function(e){setOverallCommentContents(e)})}function injectTotalScoreBox(e){return renderTotalScoreBox(e).then(function(e){setTotalScoreBoxContents(e)})}function injectRubricTotalBox(e){return renderRubricTotalBox(e).then(function(e){setRubricTotalBoxContents(e)})}OLD_MARK_LIST={},OLD_GRADED_COMPONENT_LIST={},NO_COMPONENT_ID=-1,CUSTOM_MARK_ID=0,MARK_ID_COUNTER=0,EDIT_MODE_ENABLED=!1,COUNT_DIRECTION_UP=1,COUNT_DIRECTION_DOWN=-1,PDF_PAGE_NONE=0,PDF_PAGE_STUDENT=-1,PDF_PAGE_INSTRUCTOR=-2,AJAX_USE_ASYNC=!0;