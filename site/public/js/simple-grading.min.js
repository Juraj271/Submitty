function calcSimpleGraderStats(e){var t,o,a,n=0,r=0,i=[],s=[],l={},c={},d={},u=0,p=0,f=0,h=[];if("lab"==e)o="td",a="data-score";else{if("numeric"!=e)return console.log("Invalid grading type:"),void console.log(e);o="input",a="value"}for(t=$(o+"[id^=cell-][id$=0]");t.length>0;){if("lab"==e||1==t.data("num")){var g,v=0,m=0,k=0;t.each(function(){if("lab"==e?(g=$(this).parent().find("td:nth-child(2)").text(),C=$(this).parent().parent().attr("id").split("-")[1]):"numeric"==e&&(g=$(this).parent().parent().find("td:nth-child(2)").text(),C=$(this).parent().parent().parent().attr("id").split("-")[1]),""!=g){if(C in l||(l[C]=0,c[C]=0,d[C]=0),0==p){var t;f++,l[C]++,h.push(!1);var o=0;"lab"==e?t=$(this).parent().find("td.cell-grade"):"numeric"==e&&(t=$(this).parent().parent().find("input[data-num=true]")),t.each(function(){o+=parseFloat($(this).attr(a))}),c[C]+=o,d[C]+=o**2}o=parseFloat($(this).attr(a)),h[k]||(h[k]=0!=o,h[k]&&u++),v+=o,m+=o**2}k++}),i.push(v/f),s.push(Math.sqrt(Math.max(0,(m-v**2/f)/f)))}t=$(o+"[id^=cell-][id$="+(++p).toString()+"]")}var b,y,w=$("#simple-stats-popup");for(p=0;p<i.length;p++)n+=i[p],r+=s[p]**2,w.find("#avg-component-"+p.toString()).text(i[p].toFixed(2)),w.find("#stddev-component-"+p.toString()).text(s[p].toFixed(2));for(var C in r=Math.sqrt(r),w.find("#avg-total").text(n.toFixed(2)),w.find("#stddev-total").text(r.toFixed(2)),l)b=c[C]/l[C],y=Math.sqrt(Math.max(0,(d[C]-c[C]**2/l[C])/l[C])),w.find("#avg-section-"+C).text(b.toFixed(2)),w.find("#stddev-section-"+C).text(y.toFixed(2));var x=w.find("#num-graded");$(x).text(u.toString()+"/"+f.toString())}function showSimpleGraderStats(e){"none"==$("#simple-stats-popup").css("display")?(calcSimpleGraderStats(e),$(".popup").css("display","none"),$("#simple-stats-popup").css("display","block"),$(document).on("click",function(e){"simple-stats-btn"!=$(e.target).attr("id")&&"simple-stats-popup"!=$(e.target).closest("div").attr("id")&&($("#simple-stats-popup").css("display","none"),$(document).off("click"))})):($("#simple-stats-popup").css("display","none"),$(document).off("click"))}function updateCheckpointCells(e,t,o){var a=null;t&&"object"!=typeof t&&(a=t);var n={},r={};(e=$(e)).each(function(e,o){var i=$(o),s=!1;r[i.data("id")]=i.data("score"),a?(i.data("score",a),s=!0):t&&i.data("id")in t?(i.data("score",t[i.data("id")]),s=!0):t||(1===i.data("score")?i.data("score",.5):.5===i.data("score")?i.data("score",0):i.data("score",1),s=!0),s&&(n[i.data("id")]=i.data("score"),1===i.data("score")?i.css("background-color","#149bdf"):.5===i.data("score")?i.css("background-color","#88d0f4"):i.css("background-color",""),i.css("border-right","60px solid #ddd"))});var i=$(e[0]).parent(),s=i.data("user"),l=i.data("gradeable");o||generateCheckpointCookie(s,l,r,n),submitAJAX(buildCourseUrl(["gradeable",l,"grading"]),{csrf_token:csrfToken,user_id:s,old_scores:r,scores:n},function(){e.each(function(e,t){(t=$(t)).animate({"border-right-width":"0px"},400),t.attr("data-score",t.data("score"))})},function(){e.each(function(e,t){(t=$(t)).stop(!0,!0),t.css("border-right","60px solid #DA4F49")})})}function getCheckpointHistory(e){for(var t=e+"_history=",o=decodeURIComponent(document.cookie).split(";"),a=0;a<o.length;a++){for(var n=o[a];" "==n.charAt(0);)n=n.substring(1);if(0==n.indexOf(t))return JSON.parse(n.substring(t.length,n.length))}return[0]}function setCheckpointHistory(e,t){var o=new Date(Date.now());o.setDate(o.getDate()+1),document.cookie=e+"_history="+JSON.stringify(t)+"; expires="+o.toUTCString()}function generateCheckpointCookie(e,t,o,a){var n=getCheckpointHistory(t);n[0]<n.length-1&&(n=n.slice(0,n[0])),n.push([e,o]),n.push([e,a]),n.length>1&&$("#checkpoint-undo").prop("disabled",!1),$("#checkpoint-redo").prop("disabled",!0),n.length>11?n.splice(1,2):n[0]=n.length-1,setCheckpointHistory(t,n)}function checkpointRollTo(e,t){var o=getCheckpointHistory(e),a=[],n=Math.sign(t),r=o[0];for(r+t<1&&(t=1-r),r+t>=o.length&&(t=o.length-1-r),n>0&&r%2?(r+=1,t-=n,a.push(o[r])):n<0&&!(r%2)&&(r-=1,t-=n,a.push(o[r]));0!=t;)r+=2*n,a.push(o[r]),t-=n;$("#checkpoint-undo").prop("disabled",!1),$("#checkpoint-redo").prop("disabled",!1),r<=1&&$("#checkpoint-undo").prop("disabled",!0),r>=o.length-1&&$("#checkpoint-redo").prop("disabled",!0),o[0]=r,setCheckpointHistory(e,o),a.forEach(function(e){updateCheckpointCells($("tr[data-user='"+e[0]+"'] .cell-grade"),e[1],!0)})}function setupCheckboxCells(){$("td.cell-grade").click(function(){updateCheckpointCells(this)}),$("#show-graders").on("change",function(){$(this).is(":checked")?$(".simple-grade-grader").css("display","block"):$(".simple-grade-grader").css("display","none")}),$("#show-dates").on("change",function(){$(this).is(":checked")?$(".simple-grade-date").css("display","block"):$(".simple-grade-date").css("display","none")});var e=getCheckpointHistory($("tr#row-0").data("gradeable"));e.length>1&&($("#checkpoint-undo").prop("disabled",!1),e[0]<e.length-1&&$("#checkpoint-redo").prop("disabled",!1))}function setupNumericTextCells(){$(".cell-grade").change(function(){if(elem=$(this),""!=this.value){0==this.value?elem.css("color","#bbbbbb"):elem.css("color","");var e=elem.attr("id").split("-")[1],t=$("tr#row-"+e),o={},a={},n=0;t.find(".cell-grade").each(function(){elem=$(this),elem.data("num")&&(n+=parseFloat(elem.val())),a[elem.data("id")]=elem.data("origval")+"",o[elem.data("id")]=elem.val(),elem.data("origval",elem.val()),elem.attr("data-origval",elem.val())}),t.find(".cell-total").each(function(){this.value=n}),submitAJAX(buildCourseUrl(["gradeable",t.data("gradeable"),"grading"]),{csrf_token:csrfToken,user_id:t.data("user"),old_scores:a,scores:o},function(){elem.css("background-color","#ffffff"),elem.attr("value",this.value),t.children("td.option-small-output").each(function(){$(this).children(".option-small-box").each(function(){$(this).attr("value",this.value)})})},function(){elem.css("background-color","#ff7777")})}}),$("input[class=csvButtonUpload]").change(function(){var e;if(window.confirm("WARNING! \nPreviously entered data may be overwritten! This action is irreversible! Are you sure you want to continue?\n\n Do not include a header row in your CSV. Format CSV using one column for student id and one column for each field. Columns and field types must match.")){if(e=$("#csvUpload").get(0).files[0]){var t=new FileReader;t.readAsText(e),t.onload=function(e){for(var o=!1,a=t.result.trim().split(/\r\n|\n/),n=a[0].split(","),r=n.length,i=0;i<a.length&&!o;i++)n=a[i].split(","),o=n.length!==r;var s=0,l=0,c=0,d=[],u=!0,p="";o||$(".cell-all").each(function(){if(d.push($(this).parent().data("user")),u){if(l=$(this).parent().parent().data("numnumeric"),c=$(this).parent().parent().data("numtext"),$(this).parent().parent().data("compids"),p=$(this).parent().data("gradeable"),u=!1,r!==4+l+c)return o=!0,!1;var e=3;if(n=a[0].split(","),l>0)for(e=3;e<l+4;e++)if(isNaN(Number(n[e])))return o=!0,!1;for(;e<r;)s++,e++;if(s!==c)return o=!0,!1}}),o||submitAJAX(buildCourseUrl(["gradeable",p,"grading","csv"]),{csrf_token:csrfToken,users:d,num_numeric:l,big_file:t.result},function(e){$(".cell-all").each(function(){for(var t=0;t<e.data.length;t++)if($(this).parent().data("user")===e.data[t].username){var o="value_",a="status_",n=0,r=0,i=3;for(i=3;i<l+3;i++,r++)o="value_"+r,a="status_"+r,$("#cell-"+$(this).parent().data("row")+"-"+(i-3)).val(e.data[t][o]),"OK"===e.data[t][a]?$("#cell-"+$(this).parent().data("row")+"-"+(i-3)).css("background-color","#ffffff"):$("#cell-"+$(this).parent().data("row")+"-"+(i-3)).css("background-color","#ff7777"),0==$("#cell-"+$(this).parent().data("row")+"-"+(i-3)).val()?$("#cell-"+$(this).parent().data("row")+"-"+(i-3)).css("color","#bbbbbb"):$("#cell-"+$(this).parent().data("row")+"-"+(i-3)).css("color",""),n+=Number($("#cell-"+$(this).parent().data("row")+"-"+(i-3)).val());$("#total-"+$(this).parent().data("row")).val(n),i++;for(var s=0;s<c;)o="value_"+r,a="status_"+r,$("#cell-"+$(this).parent().data("row")+"-"+(i-3-1)).val(e.data[t][o]),i++,r++,s++;t=e.data.length}})},function(){alert("submission error")}),o&&alert("CSV upload failed! Format file incorrect.")}}}else(e=$("#csvUpload")).replaceWith(e=e.clone(!0))})}function setupSimpleGrading(e){function t(e){var t=$("#student-search > ul > li");1==t.length?$(t[0]).children("div").addClass("ui-state-active"):e&&$(t[0]).children("div").removeClass("ui-state-active")}"lab"===e?setupCheckboxCells():"numeric"===e&&setupNumericTextCells();var o=!0;function a(e){var t=$(".cell-grade:focus");if(t.length){var o=t.attr("id").split("-");o[1]=parseInt(o[1]),o[2]=parseInt(o[2]),"up"==e?o[1]-=1:"down"==e?o[1]+=1:"left"==e?o[2]-=1:"right"==e&&(o[2]+=1);var a=$("#"+o.join("-"));a.length&&(t.blur(),a.focus(),a.select(),"up"!=e&&"down"!=e||a.isInViewport()||$("html, body").animate({scrollTop:a.offset().top-$(window).height()/2},50))}}function n(e,t){var o=$(".cell-grade:focus");o.length&&updateCheckpointCells(o,t.score)}function r(e,t){var o=$(".cell-grade:focus");o.length&&updateCheckpointCells(o.parent().find(".cell-grade"),t.score)}$("#student-search-input").focus(function(e){o=!0}),$(document).on("keyup",function(e){13!=e.keyCode||o||$("#student-search-input").focus()}),$(document).on("keydown",function(e){var t=$("input.cell-grade:focus");37!=e.keyCode||t.length&&(0!=t[0].selectionStart||t[0].selectionEnd-t[0].selectionStart!=0)?38==e.keyCode?(e.preventDefault(),a("up")):39!=e.keyCode||t.length&&(t[0].selectionEnd!=t[0].value.length||t[0].selectionEnd-t[0].selectionStart!=0)?40==e.keyCode&&(e.preventDefault(),a("down")):(e.preventDefault(),a("right")):(e.preventDefault(),a("left"))}),registerKeyHandler({name:"Search",code:"Enter",locked:!0},function(){}),"lab"==e?(registerKeyHandler({name:"Move Right",code:"ArrowRight",locked:!1},function(e){e.preventDefault(),a("right")}),registerKeyHandler({name:"Move Left",code:"ArrowLeft",locked:!1},function(e){e.preventDefault(),a("left")}),registerKeyHandler({name:"Move Up",code:"ArrowUp",locked:!1},function(e){e.preventDefault(),a("up")}),registerKeyHandler({name:"Move Down",code:"ArrowDown",locked:!1},function(e){e.preventDefault(),a("down")})):(registerKeyHandler({name:"Move Right",code:"ArrowRight",locked:!0},function(){}),registerKeyHandler({name:"Move Left",code:"ArrowLeft",locked:!0},function(){}),registerKeyHandler({name:"Move Up",code:"ArrowUp",locked:!0},function(){}),registerKeyHandler({name:"Move Down",code:"ArrowDown",locked:!0},function(e){})),"lab"==e&&(registerKeyHandler({name:"Set Cell to 0",code:"KeyZ",options:{score:0}},n),registerKeyHandler({name:"Set Cell to 0.5",code:"KeyX",options:{score:.5}},n),registerKeyHandler({name:"Set Cell to 1",code:"KeyC",options:{score:1}},n),registerKeyHandler({name:"Cycle Cell Value",code:"KeyV",options:{score:null}},n),registerKeyHandler({name:"Set Row to 0",code:"KeyA",options:{score:0}},r),registerKeyHandler({name:"Set Row to 0.5",code:"KeyS",options:{score:.5}},r),registerKeyHandler({name:"Set Row to 1",code:"KeyD",options:{score:1}},r),registerKeyHandler({name:"Cycle Row Value",code:"KeyF",options:{score:null}},r)),$("#student-search-input").on("keyup",function(e){if(13==e.keyCode){this.blur();var t=$(this).val();if(""!=t){var o=$(".cell-grade:focus"),a=$('table tbody tr[data-user="'+t+'"]');if(a.length>0){var n=$("#cell-"+a.attr("data-row")+"-0");o.blur(),n.focus(),$("html, body").animate({scrollTop:n.offset().top-$(window).height()/2},50)}else{var r=$("#student-search > ul > li");if(1==r.length){for(var i=r.text(),s="",l=0;l<student_full.length;l++)if(student_full[l].label==i){s=student_full[l].value;break}this.focus(),$(this).val(s),$(this).trigger(e)}else alert("ERROR:\n\nInvalid user."),this.focus()}}}}),$("#student-search-input").on("keydown",function(){t(!1)}),$("#student-search").on("DOMSubtreeModified",function(){t(!0)}),$("#student-search-input").on("focus",function(e){$(this).val("")});var i=$("#checkpoint-sticky").offset();$(window).on("scroll",function(e){var t=$("#checkpoint-sticky");i.top<$(window).scrollTop()?t.addClass("sticky-top"):t.removeClass("sticky-top")}),i.top<$(window).scrollTop()&&$("#checkpoint-sticky").addClass("sticky-top"),$(window).on("resize",function(e){var t=$("#settings-btn").offset();(i={top:t.top}).top<$(window).scrollTop()&&$("#checkpoint-sticky").addClass("sticky-top")})}