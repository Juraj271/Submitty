let updateInProgressCount=0,errors={};function updateErrorMessage(){0!==Object.keys(errors).length?$("#save_status").html('<span style="color: red">Some Changes Failed!</span>'):0===updateInProgressCount&&$("#save_status").html("All Changes Saved")}function setError(e,r){$('[name="'+e+'"]').each(function(e,a){a.title=r,a.style.backgroundColor="#FDD"}),errors[e]=r}function clearError(e,r){$('[name="'+e+'"]').each(function(e,a){a.title="",a.style.backgroundColor="",void 0!==r&&$(a).val(r)}),delete errors[e]}function setGradeableUpdateInProgress(){$("#save_status").html("Saving..."),updateInProgressCount++}function setGradeableUpdateComplete(){updateInProgressCount--}function updatePdfPageSettings(){let e=$("#yes_pdf_page").is(":checked"),r=$("#yes_pdf_page_student").is(":checked");!1===e&&$("#no_pdf_page_student").prop("checked",!0),setPdfPageAssignment(!1===e?PDF_PAGE_NONE:!0===r?PDF_PAGE_STUDENT:PDF_PAGE_INSTRUCTOR).catch(function(e){alert("Failed to update pdf page setting! "+e.message)})}function onPrecisionChange(){ajaxUpdateGradeableProperty(getGradeableId(),{precision:$("#point_precision_id").val(),csrf_token:csrfToken},function(){clearError("precision"),updateErrorMessage(),closeAllComponents(!0).then(function(){return reloadInstructorEditRubric(getGradeableId())}).catch(function(e){alert("Failed to reload the gradeable rubric! "+e.message)})},updateGradeableErrorCallback)}function updateGradeableErrorCallback(e,r){for(let e in r)r.hasOwnProperty(e)&&setError(e,r[e]);updateErrorMessage()}function ajaxRebuildGradeableButton(){var e=$("#g_id").val();$.ajax({url:buildCourseUrl(["gradeable",e,"rebuild"]),success:function(e){ajaxCheckBuildStatus()},error:function(e){console.error(e)}})}function ajaxGetBuildLogs(e){$.getJSON({type:"GET",url:buildCourseUrl(["gradeable",e,"build_log"]),success:function(e){var r=e.data[0],a=e.data[1],t=e.data[2];null!=r?$("#build-log-body").html(r):$("#build-log-body").html("There is currently no build output."),null!=a?$("#cmake-log-body").html(a):$("#cmake-log-body").html("There is currently no cmake output."),null!=t?$("#make-log-body").html(t):$("#make-log-body").html("There is currently no make output."),$(".log-container").show(),$("#open-build-log").hide(),$("#close-build-log").show()},error:function(e){console.error("Failed to parse response from server: "+e)}})}function ajaxCheckBuildStatus(){var e=$("#g_id").val();$("#rebuild-log-button").css("display","none"),hideBuildLog(),$.getJSON({type:"GET",url:buildCourseUrl(["gradeable",e,"build_status"]),success:function(r){$("#rebuild-log-button").css("display","block"),"queued"==r.data?($("#rebuild-status").html(e.concat(" is in the rebuild queue...")),$("#rebuild-log-button").css("display","none"),$('[name="config_search_error"]').hide(),setTimeout(ajaxCheckBuildStatus,1e3)):"processing"==r.data?($("#rebuild-status").html(e.concat(" is being rebuilt...")),$("#rebuild-log-button").css("display","none"),$('[name="config_search_error"]').hide(),setTimeout(ajaxCheckBuildStatus,1e3)):1==r.data?$("#rebuild-status").html("Gradeable build complete"):0==r.data?($("#rebuild-status").html("Gradeable build failed"),$('[name="config_search_error"]').show()):($("#rebuild-status").html("Error"),console.error("Internal server error, please try again."))},error:function(e){console.error("Failed to parse response from server: "+e)}})}function ajaxUpdateGradeableProperty(e,r,a,t){let s=$("#container-rubric");0!==s.length?s.is(":visible")&&(setGradeableUpdateInProgress(),$.getJSON({type:"POST",url:buildCourseUrl(["gradeable",e,"update"]),data:r,success:function(r){Array.isArray(r.data)&&r.data.includes("rebuild_queued")&&ajaxCheckBuildStatus(e,"unknown"),setGradeableUpdateComplete(),"success"===r.status?a(r.data):"fail"===r.status?t(r.message,r.data):(alert("Internal server error"),console.error(r.message))},error:function(e){setGradeableUpdateComplete(),console.error("Failed to parse response from server: "+e)}})):alert("UPDATES DISABLED: no 'container-rubric' element!")}function serializeRubric(){return function(){let e={},r=this.serializeArray(),a=["numeric_label_0","max_score_0","numeric_extra_0","numeric_extra_0","text_label_0","checkpoint_label_0","num_numeric_items","num_text_items"];return $.each(r,function(){0===$("#gradeable_rubric").find('[name="'+this.name+'"]').length&&a.push(this.name)}),$(".ignore").each(function(){a.push($(this).attr("name"))}),$(".checkpoints-table").find(".multi-field").each(function(){var r="",t=!1,s=!1;$(this).find(".checkpoint_label").each(function(){r=$(this).val(),-1!==$.inArray($(this).attr("name"),a)&&(s=!0),a.push($(this).attr("name"))}),s||($(this).find(".checkpoint_extra").each(function(){t=$(this).is(":checked"),a.push($(this).attr("name"))}),void 0===e.checkpoints&&(e.checkpoints=[]),e.checkpoints.push({label:r,extra_credit:t}))}),$(".text-table").find(".multi-field").each(function(){var r="",t=!1;$(this).find(".text_label").each(function(){r=$(this).val(),-1!==$.inArray($(this).attr("name"),a)&&(t=!0),a.push($(this).attr("name"))}),t||(void 0===e.text&&(e.text=[]),e.text.push({label:r}))}),$(".numerics-table").find(".multi-field").each(function(){var r="",t=0,s=!1,n=!1;$(this).find(".numeric_label").each(function(){r=$(this).val(),-1!==$.inArray($(this).attr("name"),a)&&(n=!0),a.push($(this).attr("name"))}),n||($(this).find(".max_score").each(function(){t=parseFloat($(this).val()),a.push($(this).attr("name"))}),$(this).find(".numeric_extra").each(function(){s=$(this).is(":checked"),a.push($(this).attr("name"))}),void 0===e.numeric&&(e.numeric=[]),e.numeric.push({label:r,max_score:t,extra_credit:s}))}),$.each(r,function(){-1===$.inArray(this.name,a)&&(e[this.name]=this.value||"")}),e}.call($("form"))}function saveRubric(e=!0){let r=serializeRubric();$("#save_status").html("Saving Rubric..."),$.getJSON({type:"POST",url:buildCourseUrl(["gradeable",$("#g_id").val(),"rubric"]),data:{values:r,csrf_token:csrfToken},success:function(r){"success"===r.status?(delete errors.rubric,updateErrorMessage(),e&&window.location.replace(buildCourseUrl(["gradeable",$("#g_id").val(),"update"])+"?nav_tab=2")):(errors.rubric=r.message,updateErrorMessage(),alert("Error saving rubric, you may have tried to delete a component with grades.  Refresh the page"))},error:function(e){alert("Error saving rubric.  Refresh the page"),console.error("Failed to parse response from server: "+e)}})}function serializeGraders(){let e={},r=parseInt($("#minimum_grading_group").val());return $("#grader_assignment").find("input").each(function(){let a=this.name.split("_");("grader"==a[0]?a[1].substr(1):a[0].substr(1))>r?$("#all_access").is(":checked")&&$(this).prop("checked",!1):($("#all_access").is(":checked")&&$(this).prop("checked",!0),"grader"===a[0]&&$(this).is(":checked")&&(a[3]in e||(e[a[3]]=[]),e[a[3]].push(a[2])))}),e}function saveGraders(){let e=serializeGraders();$("#save_status").html("Saving Graders..."),$.getJSON({type:"POST",url:buildCourseUrl(["gradeable",$("#g_id").val(),"graders"]),data:{graders:e,csrf_token:csrfToken},success:function(e){"success"!==e.status?(alert("Error saving graders!"),console.error(e.message),errors.graders=""):delete errors.graders,updateErrorMessage()},error:function(e){alert("Error saving graders!"),console.error("Failed to parse response from server: "+e)}})}function showBuildLog(){ajaxGetBuildLogs($("#g_id").val())}function hideBuildLog(){$(".log-container").hide(),$("#open-build-log").show(),$("#close-build-log").hide()}$(document).ready(function(){window.onbeforeunload=function(e){0!==Object.keys(errors).length&&(e.returnValue=1)},ajaxCheckBuildStatus(),$("input,select,textarea").change(function(){if($(this).hasClass("ignore"))return;if($("#gradeable_rubric").find('[name="'+this.name+'"]').length>0)return void($("#radio_electronic_file").is(":checked")||saveRubric(!1));if($("#grader_assignment").find('[name="'+this.name+'"]').length>0)return void saveGraders();if("all_access"!=$(this).prop("id")&&"minimum_grading_group"!=$(this).prop("id")||saveGraders(),$(this).hasClass("ignore"))return;let e={csrf_token:csrfToken};e[this.name]=$(this).val();($("#gradeable-dates").find('input[name="'+this.name+'"]').length>0||$(this).hasClass("date-related"))&&$("#gradeable-dates :input,.date-related").each(function(r,a){("radio"!==a.type||$(a).is(":checked"))&&($("#no_late_submission").is(":checked")&&"late_days"===$(a).attr("name")&&$(a).val("0"),e[a.name]=$(a).val())}),ajaxUpdateGradeableProperty($("#g_id").val(),e,function(r){for(let e in r)r.hasOwnProperty(e)&&clearError(e,r[e]);for(let r in e)e.hasOwnProperty(r)&&clearError(r);updateErrorMessage()},updateGradeableErrorCallback)})});